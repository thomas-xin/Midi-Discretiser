<!DOCTYPE html>
<!-- Code boilerplate generated by OpenAI o4-mini -->
<html lang="en">
<!-- <script src="https://unpkg.com/@tonejs/midi"></script> -->
<!-- === Include @tonejs/midi UMD build via unpkg === -->
<!-- This version attaches a global `Midi` constructor you can do `new Midi(...)`. :contentReference[oaicite:1]{index=1} -->
<script src="/Midi-Discretiser/Midi.js"></script>
<head>
	<meta charset="UTF-8" />
	<title>MIDI Discretiser</title>
	<style>
body {
	background-color: black;
	color: white;
	font-family: sans-serif;
	padding: 2rem;
	max-width: 500px;
	margin: auto;
}

h1 {
	color: #00ffff;
	margin-bottom: 1rem;
	font-size: 1.5rem;
}

input,
button {
	margin-top: 0.5rem;
	display: block;
}

#downloadLink {
	margin-top: 1rem;
	display: none;
}
	</style>
</head>

<body>
	<h1>MIDI Discretiser</h1>
	<!-- 1) File input -->
	<label for="midiFile">Choose a MIDI file:</label>
	<input type="file" id="midiFile" accept=".mid,.midi" />
	<!-- 2) Process button (disabled until a file is chosen) -->
	<button id="transposeBtn" style="background-color:#7fff7f" disabled>Remove Pitchbends</button>
	<!-- 3) Download link appears here once processing is done -->
	<a id="downloadLink">Save MIDI</a>
	<script>
function getLatest(arr, i) {
	let j = i;
	let v = arr[j];
	while (typeof v == "undefined") {
		j -= 1
		if (j < 0) {
			v = 0;
			break;
		}
		v = arr[j];
	}
	arr[i] = v;
	return v;
}

function mergeTracks(t1, t2) {
	if (t2.notes.length) {
		t1.notes.push(...t2.notes);
		t1.notes.sort((a, b) => a - b);
	}
	if (t2.pitchBends.length) {
		t1.pitchBends.push(...t2.pitchBends);
		t1.pitchBends.sort((a, b) => a - b);
	}
	if (typeof t2.controlChanges[6] != "undefined" && t2.controlChanges[6].length) {
		if (typeof t1.controlChanges[6] == "undefined") t1.controlChanges[6] = [];
		t1.controlChanges[6].push(...t2.controlChanges[6]);
		t1.controlChanges[6].sort((a, b) => a - b);
	}
	if (t1.instrument.number == 0) t1.instrument = t2.instrument;
	return t1;
}

(function() {
	const fileInput = document.getElementById("midiFile");
	const transposeBtn = document.getElementById("transposeBtn");
	const downloadLink = document.getElementById("downloadLink");
	let originalArrayBuffer = null;
	// 1) When a file is selected, read it as ArrayBuffer
	fileInput.addEventListener("change", (event) => {
		const file = event.target.files[0];
		if (!file) return;
		// Reset any previous state
		transposeBtn.disabled = true;
		downloadLink.style.display = "none";
		downloadLink.removeAttribute("href");
		downloadLink.removeAttribute("download");
		const reader = new FileReader();
		reader.onload = () => {
			originalArrayBuffer = reader.result;
			transposeBtn.disabled = false;
		};
		reader.onerror = () => {
			alert("Failed to read the file.");
		};
		reader.readAsArrayBuffer(file);
	});
	// 2) When apply button is clicked, do the processing
	transposeBtn.addEventListener("click", () => {
		if (!originalArrayBuffer) return;
		try {
			// Now that weâ€™ve loaded the UMD build, `Midi` is a global constructor
			const midi = new Midi(originalArrayBuffer);
			let m = 0;
			for (const track of midi.tracks) {
				m++;
			}
			const channels = {};
			let n = 0;
			while (n < midi.tracks.length) {
				const track = midi.tracks[n];
				const c = track.channel;
				if (typeof channels[c] != "undefined") {
					channels[c] = mergeTracks(channels[c], track);
					midi.tracks.splice(n, 1);
				} else {
					channels[c] = track;
					n++;
				}
			}
			midi.tracks.forEach((track) => {
				if (track.channel == 9 || !track.pitchBends.length || !track.notes.length) return;
				const bends = [];
				for (const bend of track.pitchBends) {
					if (bends.length || bend.value != 0) {
						bends[bend.ticks] = bend.value;
					}
				}
				if (!bends.length) return;
				const last_note = track.notes[track.notes.length - 1];
				const ticks_per_second = last_note.ticks / last_note.time;
				let pitchbend_range = 2;
				const newNotes = [];
				track.notes.forEach((note) => {
					if (typeof track.controlChanges[6] != "undefined" && note.ticks >= track.controlChanges[6][0].ticks) {
						const c = track.controlChanges[6].shift().value;
						pitchbend_range = Math.round(c * 127);
					}
					const length = Math.round(note.duration * ticks_per_second);
					let last_bend = 0;
					let last_end = 0;
					const original_start = note.time;
					const original_end = note.time + note.duration;
					const ticks = note.ticks;
					const pitch = note.midi;
					for (let i = 0; i < length; i++) {
						const bend = Math.round(pitchbend_range * getLatest(bends, ticks + i));
						if (bend != last_bend) {
							last_bend = bend;
							if (i == 0) {
								note.midi += bend;
							} else if (!last_end) {
								const newNote = {
									midi: pitch + bend,
									time: original_start + i / ticks_per_second,
									duration: original_end - original_start - i / ticks_per_second,
									velocity: note.velocity
								};
								newNotes.push(newNote);
								last_end = i / ticks_per_second;
								note.duration = last_end;
								note = newNote;
							} else {
								const newNote = {
									midi: pitch + bend,
									time: original_start + i / ticks_per_second,
									duration: original_end - original_start - i / ticks_per_second,
									velocity: note.velocity
								};
								newNotes.push(newNote);
								note.duration = i / ticks_per_second - last_end;
								last_end = i / ticks_per_second;
								note = newNote;
							}
						}
					}
				});
				for (const note of newNotes) {
					track.addNote(note);
				}
			});
			midi.tracks.forEach((track) => {
				track.pitchBends.length = 0;
			});
			// Encode back to Uint8Array
			const newBytes = midi.toArray();
			// Create a Blob & object URL for download
			const blob = new Blob([newBytes], {
				type: "audio/midi"
			});
			const url = URL.createObjectURL(blob);
			// Show the download link
			downloadLink.href = url;
			const paths = fileInput.value.replaceAll("\\", "/").split("/");
			const names = paths[paths.length - 1].split(".");
			const ext = names.pop();
			downloadLink.download = names.join(".") + "~1." + ext;
			downloadLink.textContent = "Download discretised MIDI";
			downloadLink.style.display = "inline-block";
		} catch (err) {
			console.error(err);
			alert("Error processing MIDI file. Is it a valid .mid/.midi?");
		}
	});
})();
	</script>
</body>
</html>